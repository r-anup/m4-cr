<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: include(~{::title},~{::link},~{::style},~{::script},~{::body})}">
<head>
    <title>Analyze - Consumer Reports</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        .stats {
            display: flex;
            flex-flow: row wrap;
        }

        .chart__stat--compare {
            display: grid;
            width: 100%;
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            border-bottom: 1px solid #888;
            text-align: right;
        }

        .edited {
            background-color: yellow !important;
        }

        .chart__stat-metric {
            padding: 10px 10px 10px 60px;
        }

        .chart__stat-number--compare {
            font-weight: 800;
            font-size: 6rem;
        }

        .chart__stat-metric-title {
            color: #333;
            font-weight: 600;
            line-height: 1.6rem;
            text-align: left;
        }

        .chart__stat-metric-title-description {
            font-size: 1.3rem;
            font-weight: 200;

        }

        .nochange {
            color: #a2a2a2;
        }

        .good {
            color: #5cb85c;
        }

        .bad {
            color: #d9534f;
        }

        .oi-minus {
            font-size: 4rem;
        }

        .dotted {
            border: 1px dotted #ff0000;
            border-style: none none dotted;
            color: #fff;
            background-color: #fff;
        }

        .dotted-underline {
            text-decoration-style: dotted;
            text-decoration-line: underline;
            cursor: pointer;
            color: #3939fd;
        }
        
        .ui-datepicker-trigger {
            visibility: hidden;
            width: 1px;
            padding: 0;
            margin: 0;
        }

        .file-type-chart, .tasks-chart {
            height: 300px;
            padding-left: 0;
            margin-left: 60px;
        }

        .chart-lighthouse-score {
            width: 100px;
            height: 100px;
            line-height: 100px;
            border-radius: 50%;
            background: var(--fail-color);
            text-align: center;
            color: #fff;
            float: right;
        }


        .go-submit {
            margin-left: 1rem;
            font-size: 2rem;
            margin-top: -8px;
        }
    </style>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script th:inline="javascript">
        var globalData = {};
        globalData.url = /*[[${url} ?: 'https://www.consumerreports.org/cro/index.htm']]*/ "";
        globalData.strategy = /*[[${strategy} ?: 'mobile']]*/ "mobile";
        globalData.leftDate = /*[[${leftDate ?: new Date(Date.now()).toLocaleDateString()}]]*/ "";
        globalData.rightDate = /*[[${rightDate  ?: new Date(Date.now() - 864e5).toLocaleDateString()}]]*/ "";
  </script>

    <script>
        var datepicker = function(dateId, textId, date) {
            $("#"+dateId).datepicker({
                altField: "#"+textId,
                showOn: "button",
                buttonText: '',
                changeMonth: true,
                changeYear: true,
                maxDate: 0,
                onSelect: function(dateText, inst) {
                    $("#"+textId).html(dateText).addClass('edited');
                    $("#submit-form").show();
                },
                beforeShow: function (event, ui) {
                    var $link = $("#"+textId);
                    ui.dpDiv.offset({
                        top: $link.offset().top + 10,
                        left: $link.offset().left + 10
                    });
                }
            });

            setDateStats(dateId, date, textId);

        }
        $( function() {

            datepicker("date-left", "date-left-text", globalData.leftDate);
            datepicker("date-right", "date-right-text", globalData.rightDate);
            var urlParams = new URLSearchParams(window.location.search);
            urlParams.set('url',globalData.url);
            urlParams.set('strategy',globalData.strategy);
            urlParams.set('leftDate',globalData.leftDate);
            urlParams.set('rightDate',globalData.rightDate);
            window.history.pushState(null, null, window.location.origin +  window.location.pathname + "?" + urlParams.toString());


            displayMetricsData(globalData.url, globalData.strategy, globalData.leftDate, globalData.rightDate);

        } );


        var setDateStats = function(dateId, date, textId) {
            if (date != undefined && date != "") {
                $("#"+dateId).datepicker("setDate", date);
                $("#"+textId).html(date);
            }
            $("#"+textId).click(function() {
                $("#"+dateId).datepicker("show");
            });
            $("#" + dateId + "-header").text(new Date(date).toLocaleString('en-us', { day: 'numeric', month: 'long' }));
        }


        var displayMetricsData = function(url, strategy, leftDate, rightDate) {
            var requests = [leftDate, rightDate].map(function (date) {
                return $.ajax({
                    data: {
                        url: url,
                        strategy: strategy,
                        date: date

                    },
                    dataType: 'json',
                    method: 'GET',
                    url: '/metrics/url',
                })
            });

            $.when.apply(this, requests).then(function (leftDateResponseArr, rightDateResponseArr) {
                var leftDateResponse = {};
                var rightDateResponse = {};
                if (typeof(rightDateResponseArr) === 'undefined' || rightDateResponseArr == null || rightDateResponseArr == 'success') {
                    rightDateResponse = leftDateResponse = leftDateResponseArr;
                } else {
                    leftDateResponse = leftDateResponseArr[0];
                    rightDateResponse = rightDateResponseArr[0];
                }



                var leftdata = getScoreEntities(leftDateResponse);
                var rightdata = getScoreEntities(rightDateResponse);

                var metricsData = [];
                Object.keys(leftdata['lighthouseResult']).forEach(function (key) {
                    if (key == 'score') {
                        var compare = getDifferenceInPercentage(leftdata['lighthouseResult'].score, rightdata['lighthouseResult'].score);

                        var compareArrowClass = "oi-arrow-thick-top";
                        var compareColorClass = "good";
                        if (compare < 0) {
                            compareArrowClass = "oi-arrow-thick-bottom";
                            compareColorClass = "bad";
                        } else if (compare == 0) {
                            compareArrowClass = "oi-minus";
                            compareColorClass = "average";
                        }

                        var compareValue = Math.abs(compare) + '%';
                        if (Math.abs(compare) == 0) {
                            compareValue = "";
                        }

                        metricsData.push({
                            "title": "Lighthouse Score",
                            "sub-title": "",
                            "left-value": percentageFormatter(leftdata['lighthouseResult'].score),
                            "chart__stat-number--compare-left-class": "chart-lighthouse-score metric-bg--" + getScaleFromScore(leftdata['lighthouseResult'].score).scale,
                            "chart__stat-number--compare-right-class": "chart-lighthouse-score metric-bg--" + getScaleFromScore(leftdata['lighthouseResult'].score).scale,
                            "compare": compareValue,
                            'compare-arrow-class': compareArrowClass,
                            'compare-color-class': compareColorClass,
                            "right-value": percentageFormatter(rightdata['lighthouseResult'].score),
                            "description": "",
                        });

                        return;
                    }
                    var leftValue = leftdata['lighthouseResult'][key].displayValue;
                    var rightValue = rightdata['lighthouseResult'][key].displayValue;
                    var compareMeta = getCompareMeta(leftdata['lighthouseResult'][key], rightdata['lighthouseResult'][key]);
                    var compareArrowClass = "oi-arrow-thick-top";
                    var compareColorClass = "bad";
                    var isValueImproved = compareMeta.isValueImproved;
                    if (isValueImproved == 0) {
                        compareColorClass = "average";
                    } else if (isValueImproved > 0) {
                        compareColorClass = "good";
                    }

                    if (compareMeta.differencePercent < 0) {
                        compareArrowClass = "oi-arrow-thick-bottom";
                    } else if (compareMeta.differencePercent == 0) {
                        compareArrowClass = "oi-minus";

                    }
                    var compareValue = Math.abs(compareMeta.differencePercent) + '%';
                    if (Math.abs(compareMeta.differencePercent) == 0) {
                        compareValue = "";
                    }
                    metricsData.push({
                        "title": leftdata['lighthouseResult'][key].title,
                        "sub-title": leftdata['lighthouseResult'][key].title,
                        "left-value": leftValue,
                        "compare": compareValue,
                        'compare-arrow-class': compareArrowClass,
                        'compare-color-class': compareColorClass,
                        "right-value": rightValue,
                        "left-class": "chart__stat-metric metric--"+compareMeta.left.scale,
                        "right-class": "chart__stat-metric metric--"+compareMeta.right.scale,
                        "description": leftdata['lighthouseResult'][key].description,
                    });
                });

                metricsData.push({
                    "title": "Diagnostic Chart",
                    "sub-title": "",
                    "left-value": "",
                    "compare": "",
                    'compare-arrow-class': "",
                    'compare-color-class': "",
                    "right-value": "",
                    "left-class": "file-type-chart",
                    "right-class": "tasks-chart",
                    "description": "",
                });


                Object.keys(leftdata['diagnostics']).forEach(function (key) {
                    if (key == 'throughput') return;
                    var leftValue = leftdata['diagnostics'][key].value;
                    var rightValue = rightdata['diagnostics'][key].value;
                    var compareArrowClass = "oi-arrow-thick-top";
                    var compareColorClass = "bad";

                    var differenceInPercentage = getDifferenceInPercentage(leftValue, rightValue);
                    if (differenceInPercentage < 0) {
                        compareArrowClass = "oi-arrow-thick-bottom";
                        compareColorClass = "good";
                    } else if (differenceInPercentage == 0) {
                        compareColorClass = "average";
                        compareArrowClass = "oi-minus";
                    }



                    if ($.inArray( key, ["rtt", "maxRtt", "totalTaskTime", "maxServerLatency"] ) >= 0) {
                        leftValue = timeMiliSecondFormatter(leftValue);
                        rightValue = timeMiliSecondFormatter(rightValue);
                    }

                    if ($.inArray( key, ["totalByteWeight", "mainDocumentTransferSize"] ) >= 0) {
                        leftValue = bytesFormatter(leftValue);
                        rightValue = bytesFormatter(rightValue);
                    }

                    if ($.inArray( key, ["throughput"] ) >= 0) {
                        leftValue = bytesPerSecondFormatter(leftValue);
                        rightValue = bytesPerSecondFormatter(rightValue);
                    }

                    var compareValue = Math.abs(differenceInPercentage) + '%';
                    if (Math.abs(differenceInPercentage) == 0) {
                        compareValue = "";
                    }
                    metricsData.push({
                        "title": leftdata['diagnostics'][key].title,
                        "sub-title": leftdata['diagnostics'][key].title,
                        "left-value": leftValue,
                        "compare": compareValue,
                        'compare-arrow-class': compareArrowClass,
                        'compare-color-class': compareColorClass,
                        "right-value": rightValue,
                        "left-class": "metric--info",
                        "right-class": "metric--info",
                        "description": "",
                    });
                });

                $("#metrics-chart").loadTemplate($("#metrics-chart-template"),metricsData, {"append": true});

                plotFileTypeChart(
                    Object.keys(leftdata['diagnostics'])
                        .filter(function (key) {
                            if ($.inArray( key, ["numRequests", "numFonts", "numScripts", "numStylesheets"] ) >= 0) {
                                return true;
                            }
                        }).map(function (key) {
                        return {
                            name: leftdata['diagnostics'][key].title,
                            value: leftdata['diagnostics'][key].value
                        };
                    }), '.file-type-chart', 'Page weight', false
                );

                plotFileTypeChart(
                    Object.keys(leftdata['diagnostics'])
                        .filter(function (key) {
                            if ($.inArray( key, ["numTasksOver10ms", "numTasksOver25ms", "numTasksOver50ms", "numTasksOver100ms", "numTasksOver500ms"] ) >= 0) {
                                return true;
                            }
                        }).map(function (key) {
                        return {
                            name: leftdata['diagnostics'][key].title,
                            value: leftdata['diagnostics'][key].value
                        };
                    }), '.tasks-chart', 'Page tasks', false
                );

            });
        }
    </script>
</head>

<body>
    <div class="d-flex container-fluid col-sm-12 justify-content-left">
        <h1 class="crux-headline--standard">Page Performance Metrics</h1>
    </div>

    <div class="d-flex container-fluid col-sm-12 justify-content-left pt-4">
        <h2>For <span class="dotted-underline">Consumerreports.org [Home]</span>
            on <span id="date-left-text" class="dotted-underline"></span><input type="hidden" id="date-left">
            compared to <span id="date-right-text" class="dotted-underline">03/08/2019</span><input type="hidden" id="date-right">
        </h2>
        <button style="display: none;" id="submit-form" type="button" class="btn btn-info go-submit">Go</button>
    </div>

    <script type="text/html" id="metrics-chart-template">
        <div class="chart__stat--compare" style="color:#fdbc60;">
            <div class="chart__stat-metric chart__stat-metric-title metric-title-column"><span data-content="title">Render time</span><br><span data-content="description" class="chart__stat-metric-title-description"></span></div>
            <div data-class="left-class" class="chart__stat-metric"><span data-content="sub-title">Consumerreports</span><div class="chart__stat-number--compare" data-class="chart__stat-number--compare-left-class" data-content="left-value">1.1s</div></div>
            <div class="chart__stat-metric">&nbsp;<div class="chart__stat-number--compare" data-class="compare-color-class"><span data-content="compare">9%</span> <i data-class="compare-arrow-class" class="oi"></i></div></div>
            <div data-class="right-class" class="chart__stat-metric"><span data-content="sub-title">Consumerreports</span><div class="chart__stat-number--compare" data-class="chart__stat-number--compare-right-class"  data-content="right-value">1.2s</div></div>
        </div>
    </script>

    <div class="d-flex container-fluid col-sm-12 stats pt-4 metrics-chart lh-vars lab-data" id="metrics-chart">
        <div class="chart__stat--compare" style="text-align: right; font-weight: 800; background-color: #ccc;">
            <div class="chart__stat-metric metric-title-column">Metric</div>
            <div class="chart__stat-metric">Previous <br><span id="date-right-header"></span></div>
            <div class="chart__stat-metric">Change</div>
            <div class="chart__stat-metric">Latest <br><span id="date-left-header"></span></div>
        </div>
    </div>
</body>
</html>