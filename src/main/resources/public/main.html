<!DOCTYPE html>
<html lang="en">
<head>
    <title>Product Reviews and Ratings - Consumer Reports</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1">
    <meta name="robots" content="NOINDEX,NOFOLLOW">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.cr.org/crux/styles/2.0/css/main.css" type="text/css">

    <style>

        body {
            font-size: 2rem;
        }

        .score {
            border-radius: 50%;
            color: #fff;
            background-color: #00ae4d;
            width: 100px;
            height: 100px;
            -ms-flex-align: center;
            align-items: center;
            -ms-flex-pack: center;
            justify-content: center;
            display: -ms-flexbox;
            display: flex;
            font-size: 50px;
            margin-left: 30%;
        }
        .score.average {
            background-color: #e67700;;
        }
        .score.slow {
            background-color: #c7221f;;
        }
        #table-details .slow {
            color: #c7221f;;
        }
        #table-details .average {
            color: #e67700;;
        }
        #table-details .fast {
            color: #00ae4d;;
        }
    </style>


    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-gl/echarts-gl.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts-stat/ecStat.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/simplex.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(document).ready(function() {

            function getScale(score) {
                return score > 3 ? "slow" : score > 1 ? "average" : "fast";
            }

            $.ajax({
                url: "pagespeed.json", success: function (result) {
                    $("#records_table tbody").html('');
                    $.each(result, function (idx, elem) {
                        $("#records_table tbody").append("<tr class='target' data-url='" + elem.url + "'><td>" + elem.title + "</td><td>" + elem.url + "</td><td>" + elem.score + "</td><td>"
                            + elem.previous_score + "</td></tr>");
                    });

                    $( "#records_table" ).on( "click", ".target", function() {
                        var url_to_check = $(this).data('url');
                        $.ajax({
                            url: "http://localhost:3000/bin/pagespeed?url=" + url_to_check, success: function (result) {
                                $("#details").html('');
                                lastScore = result[0].score;
                                scoreClass = lastScore < 50 ? "slow" : lastScore < 90 ? "average" : "fast";
                                $("#details").append("<div class='score " + scoreClass + "'>" + lastScore + "</div><table id='table-details' border='1'><tr><th>First Contentful Paint</th><th>Speed Index</th><th>Time to Interactive</th>"
                                    + "<th>First Meaningful Paint</th><th>First CPU Idle</th><th>Estimated Input Latency</th></tr></table>");
                                $.each(result, function (idx, elem) {
                                    $("#table-details").append("<tr><td class='" + getScale(elem.first_contentful_paint.split(" ")[0]) + "'>" + elem.first_contentful_paint
                                        + "</td><td class='" + getScale(elem.speed_index.split(" ")[0]) + "'>" + elem.speed_index
                                        + "</td><td class='" + getScale(elem.interactive.split(" ")[0]) + "'>" + elem.interactive
                                        + "</td><td class='" + getScale(elem.first_meaningful_paint.split(" ")[0]) + "'>" + elem.first_meaningful_paint
                                        + "</td><td class='" + getScale(elem.first_cpu_idle.split(" ")[0]) + "'>" + elem.first_cpu_idle
                                        + "</td><td class='" + getScale(elem.estimated_input_latency.split(" ")[0] / 100) + "'>" + elem.estimated_input_latency + "</td></tr>");
                                });
                                legendData = [];
                                xAxisData = [];
                                seriesObj = [];
                                for (var i = 0; i < result.length; i++) {
                                    legendData[i] = result[i].url;
                                    if (legendData[i].includes("https://www.consumerreports.org")) {
                                        legendData[i] = legendData[i].slice("https://www.consumerreports.org".length, legendData[i].length)
                                    }
                                    var obj = [];
                                    for (var j = 0; j < result[i].scores.length; j++) {
                                        obj.push([new Date(result[i].scores[j].timestamp), result[i].scores[j].score, result[i].scores[j].first_contentful_paint,
                                            result[i].scores[j].speed_index, result[i].scores[j].interactive, result[i].scores[j].first_meaningful_paint,
                                            result[i].scores[j].first_cpu_idle, result[i].scores[j].estimated_input_latency]);
                                        xAxisData.push(result[i].scores[j].timestamp);
                                    }
                                    seriesObj[i] = {
                                        name: legendData[i],
                                        type: 'line',
                                        showAllSymbol: true,
                                        symbolSize: function (value) {
                                            return Math.round(value[1] / 10) + 2;
                                        },
                                        data: obj
                                    };
                                }

                                selectedData = {};
                                selectedData[legendData[0]] = true;
                                for (var x = 1; x < result.length; x++) {
                                    selectedData[legendData[x]] = false;
                                }

                                var dom = document.getElementById("container");
                                var myChart = echarts.init(dom);
                                var app = {};
                                option = null;
                                option = {
                                    title: {
                                        text: 'PageSpeed',
                                        subtext: 'for decktop'
                                    },
                                    tooltip: {
                                        trigger: 'item',
                                        formatter: function (params) {
                                            var date = new Date(params.value[0]);
                                            data = date.getFullYear() + '-'
                                                + (date.getMonth() + 1) + '-'
                                                + date.getDate() + ' '
                                                + date.getHours() + ':'
                                                + date.getMinutes();
                                            return data + '<br/>'
                                                + 'Score: ' + params.value[1] + '<br/>'
                                                + 'First Contentful Paint: ' + params.value[2] + '<br/>'
                                                + 'Speed Index: ' + params.value[3] + '<br/>'
                                                + 'Time to Interactive: ' + params.value[4] + '<br/>'
                                                + 'First Meaningful Paint: ' + params.value[5] + '<br/>'
                                                + 'First CPU Idle: ' + params.value[6] + '<br/>'
                                                + 'Estimated Input Latency: ' + params.value[7];
                                        }
                                    },
                                    toolbox: {
                                        show: true,
                                        feature: {
                                            mark: {show: true},
                                            dataView: {show: true, readOnly: true, title: "View data"},
                                            restore: {show: true, title: "Refresh"},
                                            saveAsImage: {show: true, title: "Save"}
                                        }
                                    },
                                    dataZoom: {
                                        show: true,
                                        start: 0,
                                        end: 100
                                    },
                                    legend: {
                                        selected: selectedData,
                                        data: legendData
                                    },
                                    xAxis: [
                                        {
                                            type: 'time',
                                            splitNumber: 20,
                                            name: 'Time',
                                        }
                                    ],
                                    yAxis: [
                                        {
                                            type: 'value',
                                            name: 'Score',
                                        }
                                    ],
                                    series: seriesObj
                                };
                                ;
                                if (option && typeof option === "object") {
                                    myChart.setOption(option, true);
                                }
                            }
                        });
                    });
                }
            });
        });
    </script>

</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between m-3">
            <div class="p2"><img src="images/cr-logo.svg"></div>



            <div class="p2">
                <ul class="nav justify-content-end nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="main.html">Latest Score Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="analyze.html">Analyze Pagespeed Insight</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="config.html">Configuration</a>
                    </li>

                </ul>

            </div>
        </div>

        <div class="d-flex justify-content-center pt-5">
            <div class="p2"><h1 class="crux-headline--standard">Latest Score Report</h1></div>
        </div>



        <div class="pt-3">
        <table id="records_table" class="table table-striped table-hover">
            <thead class="thead-dark">
            <tr>
                <th scope="col">TITLE</th>
                <th scope="col">URL</th>
                <th scope="col">LATEST SCORE</th>
                <th scope="col">PREVIOUS SCORE</th>
            </tr>
            </thead>
            <tbody>
            <tr><td colspan="4"><div class="d-flex justify-content-center p-4">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div></td></tr>


            <!--<tr class="target" data-url="https://www.consumerreports.org/cro/index.htm">
                <td>Homepage</td>
                <td>https://www.consumerreports.org/cro/index.htm</td>
                <td>98</td>
                <td>81</td>
            </tr>
            <tr class="target" data-url="https://www.consumerreports.org/cro/blenders.htm">
                <td>Blenders</td>
                <td>https://www.consumerreports.org/cro/blenders.htm</td>
                <td>72</td>
                <td>72</td>
            </tr>
            <tr class="target"
                data-url="https://www.consumerreports.org/privacy/how-to-delete-online-accounts-you-no-longer-need/">
                <td></td>
                <td>https://www.consumerreports.org/privacy/how-to-delete-online-accounts-you-no-longer-need/</td>
                <td>31</td>
                <td>31</td>
            </tr>-->
            </tbody>
        </table>
        </div>
        <div id="details" style="padding: 20px 0 20px 0;"></div>
        <div id="container" style="height: 100%"></div>
    </div>
    </body>
</html>